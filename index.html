<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nano Leaves Wallpaper</title>
    <style>
      body {
        background-color: black;
        overflow: hidden;
      }
      iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      #back {
        position: absolute;
        top: 0;
        left: 0;
        width: 100px;
        height: 100px;
        opacity: 0;
        transition: 0.5s;
      }
      #back:hover {
        cursor: pointer;
        background-color: red;
        opacity: 0.1;
        transition: 0.5s;
      }
    </style>
  </head>
  <body>
    <iframe id="iframe" src="" frameborder="0"></iframe>
    <div id="back"></div>

    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <svg
      width="100%"
      height="100%"
      viewBox="0 0 1920 1080"
      version="1.1"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xml:space="preserve"
      xmlns:serif="http://www.serif.com/"
      style="
        fill-rule: evenodd;
        clip-rule: evenodd;
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke-miterlimit: 1.5;
        max-height: 100vh;
      "
    >
      <g transform="matrix(0.731864,0,0,0.731864,38.3101,-192.852)">
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>

      <g transform="matrix(0.731864,0,0,0.731864,278.99,-192.852)">
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>

      <g transform="matrix(0.731864,0,0,0.731864,519.098,-192.852)">
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g
        transform="matrix(-0.731864,-8.96275e-17,8.96275e-17,-0.731864,1379.58,855.728)"
      >
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g transform="matrix(0.731864,0,0,0.731864,158.964,15.71)">
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g
        transform="matrix(-0.731864,-8.96275e-17,8.96275e-17,-0.731864,1620.26,855.728)"
      >
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g transform="matrix(0.731864,0,0,0.731864,399.015,15.71)">
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g
        transform="matrix(-0.731864,-8.96275e-17,8.96275e-17,-0.731864,1860.37,855.728)"
      >
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g
        transform="matrix(-0.731864,-8.96275e-17,8.96275e-17,-0.731864,1500.24,1064.29)"
      >
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g transform="matrix(0.731864,0,0,0.731864,278.99,224.272)">
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g
        transform="matrix(-0.731864,-8.96275e-17,8.96275e-17,-0.731864,1740.29,1064.29)"
      >
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
      <g
        transform="matrix(-0.731864,-8.96275e-17,8.96275e-17,-0.731864,1620.26,1272.85)"
      >
        <path
          d="M881.704,492.334L950.978,492.334C978.774,540.478 1017.61,607.74 1045.4,655.883L1010.77,715.876L821.916,715.876L787.279,655.883C815.075,607.74 853.908,540.478 881.704,492.334Z"
          style="stroke: rgb(49, 49, 49); stroke-width: 1.37px"
        />
      </g>
    </svg>

    <script>
      var apiBase =
        "http://192.168.0.178/api/0KW8MKn4nVwzHSJJ8pCFZAjZbEBaoRUcsX0g64YV/";

      var paths = document.querySelectorAll("path");
      var links = [
        "https://www.meteoswiss.admin.ch/home.html?tab=overview",
        "https://www.watson.ch/",
        "https://galaxy.ralf-boltshauser.com/",
        "https://portal.ralf-boltshauser.com/",
      ];
      var functionCalls = [toggleLights, setLightColor, syncLights];
      var lightsOn = false;
      var lightsIds = [];

      var iframe = document.querySelector("#iframe");
      var back = document.querySelector("#back");

      back.addEventListener("click", function () {
        iframe.src = "";
        iframe.style.opacity = 0;
        iframe.style.pointerEvents = "none";
      });
      iframe.style.opacity = 0;
      links.forEach(function (link, i) {
        paths[i].style.cursor = "pointer";
        paths[i].addEventListener("click", function () {
          iframe.src = link;
          iframe.style.opacity = 1;
          iframe.style.pointerEvents = "all";
        });
      });
      function setupLightIds() {
        lightsIds = [];
        fetch(apiBase + "lights")
          .then((response) => response.json())
          .then((data) => {
            Object.keys(data).forEach((light) => {
              var lightObject = data[light];
              if (lightObject.name.includes("Ralf")) {
                lightsIds.push(light);
              }
            });
          });
      }

      var syncLightsInterval;
      function syncLights(panelId) {
        console.log("interval: ", syncLightsInterval);
        if (syncLightsInterval !== undefined) {
          clearInterval(syncLightsInterval);
          syncLightsInterval = undefined;
          paths[panelId].style.opacity = "1";
        } else {
          syncLightsInterval = setInterval(function () {
            var lightApiCalls = [];
            lightsIds.forEach((lightId, index) => {
              var color = colors[index];
              var hsv = RGBtoHSV(color.r, color.g, color.b);
              lightApiCalls.push({
                url: "lights/" + lightId + "/state",
                method: "PUT",
                body: {
                  on: true,
                  hue: Math.floor(hsv.h * 65535),
                  sat: Math.floor(hsv.s * 254),
                  bri: Math.floor(hsv.v * 254),
                  transitiontime: 10,
                },
              });
            });
            lightsOn = !lightsOn;
            lightApiCalls.forEach((apiCall) => {
              fetch(apiBase + apiCall.url, {
                method: apiCall.method,
                body: JSON.stringify(apiCall.body),
              });
            });
          }, 2000);
          paths[panelId].style.opacity = "0.5";
        }
      }

      function setLightColor(panelId) {
        console.log(panelId);
        var color = colors[panelId];
        console.log(color);
        var hue = Math.floor(RGBtoHSV(color.r, color.g, color.b).h * 65535);
        console.log(hue);
        var lightApiCalls = [];
        lightsIds.forEach((lightId) => {
          lightApiCalls.push({
            url: "lights/" + lightId + "/state",
            method: "PUT",
            body: { on: true, hue: hue, sat: 254, transitiontime: 1 },
          });
        });
        lightsOn = !lightsOn;
        lightApiCalls.forEach((apiCall) => {
          fetch(apiBase + apiCall.url, {
            method: apiCall.method,
            body: JSON.stringify(apiCall.body),
          });
        });
        console.log("Toggle lights: ", lightsIds.length);
      }

      function toggleLights(panelId) {
        var lightApiCalls = [];
        lightsIds.forEach((lightId) => {
          lightApiCalls.push({
            url: "lights/" + lightId + "/state",
            method: "PUT",
            body: { on: !lightsOn },
          });
        });
        lightsOn = !lightsOn;
        lightApiCalls.forEach((apiCall) => {
          fetch(apiBase + apiCall.url, {
            method: apiCall.method,
            body: JSON.stringify(apiCall.body),
          });
        });
        console.log("Toggle lights: ", lightsIds.length);
      }

      function setUpFunctionCalls() {
        functionCalls.forEach(function (functionCall, i) {
          paths[i + links.length].addEventListener("click", function () {
            functionCall(i + links.length);
          });
          paths[i + links.length].style.cursor = "pointer";
        });
      }
      setupLightIds();
      toggleLights();
      setTimeout(setUpFunctionCalls, 1000);

      var length = paths.length;
      var i = 0;
      var types = [
        "blue",
        "red",
        "green",
        "yellow",
        "purple",
        "black",
        "white",
        "random",
      ];
      var type = types[0];
      var typeFixed = false;
      var typeChangeSpeed = 1;
      var updateSpeed = 1; // 1 = 1 millisecond
      var changeAmount = 10;

      // get query param type
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == "type") {
          type = pair[1];
          typeFixed = true;
        }
        if (pair[0] == "typeChangeSpeed") {
          typeChangeSpeed = pair[1];
        }
        if (pair[0] == "updateSpeed") {
          updateSpeed = pair[1];
        }
        if (pair[0] == "changeAmount") {
          changeAmount = pair[1];
        }
        if (pair[0] == "apiBase") {
          apiBase = pair[1];
        }
      }
      colors = [
        { r: 255, g: 0, b: 0 },
        { r: 0, g: 255, b: 0 },
        { r: 0, g: 0, b: 255 },
        { r: 255, g: 255, b: 0 },
        { r: 255, g: 0, b: 255 },
        { r: 0, g: 255, b: 255 },
        { r: 255, g: 255, b: 255 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 255 },
      ];
      strokes = [
        { r: 255, g: 0, b: 0 },
        { r: 0, g: 255, b: 0 },
        { r: 0, g: 0, b: 255 },
        { r: 255, g: 255, b: 0 },
        { r: 255, g: 0, b: 255 },
        { r: 0, g: 255, b: 255 },
        { r: 255, g: 255, b: 255 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 0 },
        { r: 0, g: 0, b: 255 },
      ];
      /*
      var interval = setInterval(function () {
        paths[i].style.stroke = "rgb(249, 249, 249)";
        paths[i].style.fill =
          "rgb(" + colors[i].r + "," + colors[i].g + "," + colors[i].b + ")";
        i++;
        console.log(i);
        if (i >= length) {
          clearInterval(interval);
        }
      }, 100);
      */
      function draw() {
        paths[i].style.stroke =
          "rgb(" + strokes[i].r + "," + strokes[i].g + "," + strokes[i].b + ")";
        paths[i].style.fill =
          "rgb(" + colors[i].r + "," + colors[i].g + "," + colors[i].b + ")";
        i++;
        if (i >= length) {
          i = 0;
        }
        requestAnimationFrame(draw);
      }

      var iteration = 0;
      function update() {
        var interval = setInterval(function () {
          strokes[i] = {
            r: 255,
            g: 255,
            b: 255,
          };
          colors[i] = getNewColor(colors[i], type);
          i++;
          if (i >= length) {
            i = 0;
          }
          iteration++;
          if (iteration >= 1000 * typeChangeSpeed) {
            if (!typeFixed) {
              type = types[Math.floor(Math.random() * types.length)];
              console.log(type);
            }
            iteration = 0;
          }
        }, updateSpeed);
      }

      function getNewColor(oldColor, type) {
        var newColor = { r: 0, g: 0, b: 0 };
        switch (type) {
          case "blue":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.b < 200) {
              newColor.b += changeAmount;
            }
            if (newColor.r > 150) {
              newColor.r -= changeAmount;
            }
            if (newColor.g > 150) {
              newColor.g -= changeAmount;
            }
            break;
          case "red":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.r < 200) {
              newColor.r += changeAmount;
            }
            if (newColor.g > 150) {
              newColor.g -= changeAmount;
            }
            if (newColor.b > 150) {
              newColor.b -= changeAmount;
            }
            break;
          case "green":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.g < 200) {
              newColor.g += changeAmount;
            }
            if (newColor.r > 150) {
              newColor.r -= changeAmount;
            }
            if (newColor.b > 150) {
              newColor.b -= changeAmount;
            }
            break;
          case "purple":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.r < 200) {
              newColor.r += changeAmount;
            }
            if (newColor.g > 150) {
              newColor.g -= changeAmount;
            }
            if (newColor.b < 200) {
              newColor.b += changeAmount;
            }
            break;
          case "yellow":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.r < 200) {
              newColor.r += changeAmount;
            }
            if (newColor.g < 200) {
              newColor.g += changeAmount;
            }
            if (newColor.b > 150) {
              newColor.b -= changeAmount;
            }
            break;
          case "pink":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.r < 200) {
              newColor.r += changeAmount;
            }
            if (newColor.g < 200) {
              newColor.g += changeAmount;
            }
            if (newColor.b < 200) {
              newColor.b += changeAmount;
            }
            break;
          case "black":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.r > 150) {
              newColor.r -= changeAmount;
            }
            if (newColor.g > 150) {
              newColor.g -= changeAmount;
            }
            if (newColor.b > 150) {
              newColor.b -= changeAmount;
            }
            break;
          case "white":
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            if (newColor.r < 200) {
              newColor.r += changeAmount;
            }
            if (newColor.g < 200) {
              newColor.g += changeAmount;
            }
            if (newColor.b < 200) {
              newColor.b += changeAmount;
            }
            break;
          default:
            newColor.r =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.r;
            newColor.g =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.g;
            newColor.b =
              Math.floor((Math.random() - 0.5) * changeAmount) + oldColor.b;
            break;
        }
        if (newColor.r > 255) {
          newColor.r = 255;
        }
        if (newColor.r < 0) {
          newColor.r = 0;
        }
        if (newColor.g > 255) {
          newColor.g = 255;
        }
        if (newColor.g < 0) {
          newColor.g = 0;
        }
        if (newColor.b > 255) {
          newColor.b = 255;
        }
        if (newColor.b < 0) {
          newColor.b = 0;
        }
        if (newColor.r + newColor.g + newColor.b < 250) {
          newColor.r = newColor.r + changeAmount;
          newColor.g = newColor.g + changeAmount;
          newColor.b = newColor.b + changeAmount;
        }
        return newColor;
      }

      // color converting functions
      function RGBtoHSV(r, g, b) {
        if (arguments.length === 1) {
          (g = r.g), (b = r.b), (r = r.r);
        }
        var max = Math.max(r, g, b),
          min = Math.min(r, g, b),
          d = max - min,
          h,
          s = max === 0 ? 0 : d / max,
          v = max / 255;

        switch (max) {
          case min:
            h = 0;
            break;
          case r:
            h = g - b + d * (g < b ? 6 : 0);
            h /= 6 * d;
            break;
          case g:
            h = b - r + d * 2;
            h /= 6 * d;
            break;
          case b:
            h = r - g + d * 4;
            h /= 6 * d;
            break;
        }

        return {
          h: h,
          s: s,
          v: v,
        };
      }
      function HSVtoHSL(h, s, v) {
        if (arguments.length === 1) {
          (s = h.s), (v = h.v), (h = h.h);
        }
        var _h = h,
          _s = s * v,
          _l = (2 - s) * v;
        _s /= _l <= 1 ? _l : 2 - _l;
        _l /= 2;

        return {
          h: _h,
          s: _s,
          l: _l,
        };
      }

      function HSLtoHSV(h, s, l) {
        if (arguments.length === 1) {
          (s = h.s), (l = h.l), (h = h.h);
        }
        var _h = h,
          _s,
          _v;

        l *= 2;
        s *= l <= 1 ? l : 2 - l;
        _v = (l + s) / 2;
        _s = (2 * s) / (l + s);

        return {
          h: _h,
          s: _s,
          v: _v,
        };
      }

      draw();
      update();
    </script>
  </body>
</html>
